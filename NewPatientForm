package HospitalManagementSystem;

import javax.swing.*;
import java.awt.*;
import java.io.FileWriter;
import java.io.PrintWriter;
import java.util.Calendar;

public class PatientForm extends JFrame {

    private static final long serialVersionUID = 1L;
    private JComboBox<String> cmbDoctorName;
    private JComboBox<Integer> cmbYear, cmbDay;
    private JComboBox<String> cmbMonth;
    private JComboBox<String> cmbIllness; 
    private JTextField txtTime;
    private JTextArea txtAppointmentList;
    private String patientName;

    public PatientForm(String username) {
        setIconImage(Toolkit.getDefaultToolkit().getImage("C:\\Users\\USER-PC\\Downloads\\HospitalLogo.png.png"));
        this.patientName = username;
        
        setTitle("Patient Portal - " + username);
        setExtendedState(JFrame.MAXIMIZED_BOTH); // Maximize the window
        setSize(520, 580);
        setLocationRelativeTo(null); // Center the window
        getContentPane().setLayout(null);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        
      
        getContentPane().setBackground(new Color(240, 248, 255));
        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();
        int screenWidth = screenSize.width;
        int screenHeight = screenSize.height;
        
        // Calculate margins and component sizes
        int leftMargin = 50;
        int topMargin = 30;
        int labelWidth = 150;
        int fieldWidth = Math.min(400, screenWidth - leftMargin - labelWidth - 100);
        int verticalSpacing = 50;
        
        // Medical theme colors
        Color headerColor = new Color(0, 102, 204); // Medical Blue
        Color panelColor = new Color(255, 255, 255); // White
        Color accentColor = new Color(46, 204, 113); // Medical Green
        Color dangerColor = new Color(231, 76, 60); // Red
        Color textColor = new Color(44, 62, 80); // Dark Blue Gray
        
        // Header Panel
        JPanel headerPanel = new JPanel();
        headerPanel.setBackground(headerColor);
        headerPanel.setBounds(0, 0, screenWidth, 80);
        headerPanel.setLayout(null);
        getContentPane().add(headerPanel);
        
        // Welcome message in header
        JLabel lblWelcome = new JLabel("Welcome, <dynamic>!");
        lblWelcome.setFont(new Font("Tahoma", Font.BOLD, 24));
        lblWelcome.setForeground(Color.WHITE);
        lblWelcome.setBounds(leftMargin, 20, 600, 40);
        headerPanel.add(lblWelcome);
        
        // Booking Panel
        JPanel bookingPanel = new JPanel();
        bookingPanel.setBackground(panelColor);
        bookingPanel.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(189, 195, 199), 2),
            BorderFactory.createEmptyBorder(20, 20, 20, 20)
        ));
        bookingPanel.setLayout(null);
        bookingPanel.setBounds(50, 95, 1180, 278);
        getContentPane().add(bookingPanel);

        // Book Appointment Section
        JLabel lblBooking = new JLabel("Book New Appointment");
        lblBooking.setFont(new Font("Tahoma", Font.BOLD, 18));
        lblBooking.setForeground(headerColor);
        lblBooking.setBounds(20, 0, 400, 35);
        bookingPanel.add(lblBooking);

        // Doctor input
        JLabel lblDoctor = new JLabel("Doctor Name:");
        lblDoctor.setFont(new Font("Tahoma", Font.PLAIN, 14));
        lblDoctor.setForeground(textColor);
        lblDoctor.setBounds(20, 46, labelWidth, 30);
        bookingPanel.add(lblDoctor);

        // Dropdown for doctor selection
        String[] doctors = {"Dr. Ash (Pediatricians)", "Dr. Triciajane (Cardiologist)", "Dr. Jean (Ophthalmologist)"};
        cmbDoctorName = new JComboBox<>(doctors);
        cmbDoctorName.setEditable(true);
        cmbDoctorName.setFont(new Font("Tahoma", Font.PLAIN, 14));
        cmbDoctorName.setBackground(Color.WHITE);
        cmbDoctorName.setBounds(170, 46, 400, 35);
        bookingPanel.add(cmbDoctorName);

        String[] illnesses = {
                "Fever / Flu",
                "Heart Related",
                "Eye Problem"
        };
        
        cmbIllness = new JComboBox<>(illnesses);
        cmbIllness.setFont(new Font("Tahoma", Font.PLAIN, 14));
        cmbIllness.setBounds(170, 87, 300, 35);
        bookingPanel.add(cmbIllness);

        // Date input with dropdown selectors
        JLabel lblDate = new JLabel("Appointment Date:");
        lblDate.setFont(new Font("Tahoma", Font.PLAIN, 14));
        lblDate.setForeground(textColor);
        lblDate.setBounds(20, 135, labelWidth, 30);
        bookingPanel.add(lblDate);

        // Year dropdown
        Calendar cal = Calendar.getInstance();
        int currentYear = cal.get(Calendar.YEAR);
        Integer[] years = new Integer[10];
        for (int i = 0; i < 10; i++) {
            years[i] = currentYear + i;
        }
        cmbYear = new JComboBox<>(years);
        cmbYear.setFont(new Font("Tahoma", Font.PLAIN, 14));
        cmbYear.setBackground(Color.WHITE);
        cmbYear.setBounds(170, 133, 120, 35);
        bookingPanel.add(cmbYear);

        // Month dropdown
        String[] months = {"Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                          "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
        cmbMonth = new JComboBox<>(months);
        cmbMonth.setFont(new Font("Tahoma", Font.PLAIN, 14));
        cmbMonth.setBackground(Color.WHITE);
        cmbMonth.setBounds(300, 133, 100, 35);
        cmbMonth.setSelectedIndex(cal.get(Calendar.MONTH));
        bookingPanel.add(cmbMonth);

        // Day dropdown
        Integer[] days = new Integer[31];
        for (int i = 0; i < 31; i++) {
            days[i] = i + 1;
        }
        cmbDay = new JComboBox<>(days);
        cmbDay.setFont(new Font("Tahoma", Font.PLAIN, 14));
        cmbDay.setBackground(Color.WHITE);
        cmbDay.setBounds(410, 133, 80, 35);
        cmbDay.setSelectedIndex(cal.get(Calendar.DAY_OF_MONTH) - 1);
        bookingPanel.add(cmbDay);

        // Update days when month or year changes
        cmbMonth.addActionListener(e -> updateDays());
        cmbYear.addActionListener(e -> updateDays());

        // Time input
        JLabel lblTime = new JLabel("Appointment Time:");
        lblTime.setFont(new Font("Tahoma", Font.PLAIN, 14));
        lblTime.setForeground(textColor);
        lblTime.setBounds(20, 183, labelWidth, 30);
        bookingPanel.add(lblTime);

        txtTime = new JTextField();
        txtTime.setFont(new Font("Tahoma", Font.PLAIN, 14));
        txtTime.setBounds(170, 181, 300, 35);
        txtTime.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(189, 195, 199), 1),
            BorderFactory.createEmptyBorder(5, 10, 5, 10)
        ));
        txtTime.setToolTipText("Format: HH:MM (e.g., 14:30)");
        bookingPanel.add(txtTime);

        JButton btnBookAppointment = new JButton("Book Appointment");
        btnBookAppointment.setFont(new Font("Tahoma", Font.BOLD, 14));
        btnBookAppointment.setBackground(accentColor);
        btnBookAppointment.setForeground(Color.WHITE);
        btnBookAppointment.setFocusPainted(false);
        btnBookAppointment.setBorder(BorderFactory.createEmptyBorder(10, 20, 10, 20));
        btnBookAppointment.setBounds(170, 227, 180, 40);
        btnBookAppointment.setCursor(new Cursor(Cursor.HAND_CURSOR));
        bookingPanel.add(btnBookAppointment);

        btnBookAppointment.addActionListener(e -> bookAppointment());

        // Export button
        JButton btnExport = new JButton("Export");
        btnExport.setFont(new Font("Tahoma", Font.BOLD, 14));
        btnExport.setBackground(headerColor);
        btnExport.setForeground(Color.WHITE);
        btnExport.setFocusPainted(false);
        btnExport.setBorder(BorderFactory.createEmptyBorder(10, 20, 10, 20));
        btnExport.setBounds(370, 227, 120, 40);
        btnExport.setCursor(new Cursor(Cursor.HAND_CURSOR));
        bookingPanel.add(btnExport);
        btnExport.addActionListener(e -> exportAppointments());

        // Logout button
        JButton btnLogout = new JButton("Logout");
        btnLogout.setFont(new Font("Tahoma", Font.BOLD, 14));
        btnLogout.setBackground(dangerColor);
        btnLogout.setForeground(Color.WHITE);
        btnLogout.setFocusPainted(false);
        btnLogout.setBorder(BorderFactory.createEmptyBorder(10, 20, 10, 20));
        btnLogout.setBounds(515, 227, 120, 40);
        btnLogout.setCursor(new Cursor(Cursor.HAND_CURSOR));
        bookingPanel.add(btnLogout);
        
        JLabel lblPatientIllness = new JLabel("Patient Illness:");
        lblPatientIllness.setForeground(new Color(44, 62, 80));
        lblPatientIllness.setFont(new Font("Tahoma", Font.PLAIN, 14));
        lblPatientIllness.setBounds(20, 87, 150, 30);
        bookingPanel.add(lblPatientIllness);
        btnLogout.addActionListener(e -> logout());
        
        // Appointments Panel
        JPanel appointmentsPanel = new JPanel();
        appointmentsPanel.setBackground(panelColor);
        appointmentsPanel.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(189, 195, 199), 2),
            BorderFactory.createEmptyBorder(20, 20, 20, 20)
        ));
        appointmentsPanel.setLayout(null);
        int appointmentsPanelHeight = screenHeight - 450;
        appointmentsPanel.setBounds(leftMargin, 380, screenWidth - 2 * leftMargin, appointmentsPanelHeight);
        getContentPane().add(appointmentsPanel);

        // My Appointments Section
        JLabel lblMyAppointments = new JLabel("My Appointments");
        lblMyAppointments.setFont(new Font("Tahoma", Font.BOLD, 18));
        lblMyAppointments.setForeground(headerColor);
        lblMyAppointments.setBounds(20, 10, 300, 35);
        appointmentsPanel.add(lblMyAppointments);

        txtAppointmentList = new JTextArea();
        txtAppointmentList.setEditable(false);
        txtAppointmentList.setFont(new Font("Monospaced", Font.PLAIN, 14));
        txtAppointmentList.setBackground(new Color(248, 249, 250));
        txtAppointmentList.setForeground(textColor);
        txtAppointmentList.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));
        
        JScrollPane scrollPane = new JScrollPane(txtAppointmentList);
        scrollPane.setBorder(BorderFactory.createLineBorder(new Color(189, 195, 199), 1));
        int scrollWidth = screenWidth - 2 * leftMargin - 80;
        int scrollHeight = appointmentsPanelHeight - 80;
        scrollPane.setBounds(20, 55, scrollWidth, scrollHeight);
        appointmentsPanel.add(scrollPane);
        
        // Load appointments
        updateAppointmentList();
    }

    private void updateDays() {
        int year = (Integer) cmbYear.getSelectedItem();
        int month = cmbMonth.getSelectedIndex() + 1;
        int maxDays = getMaxDaysInMonth(year, month);
        
        int currentSelection = (Integer) cmbDay.getSelectedItem();
        
        cmbDay.removeAllItems();
        for (int i = 1; i <= maxDays; i++) {
            cmbDay.addItem(i);
        }
        
        if (currentSelection <= maxDays) {
            cmbDay.setSelectedItem(currentSelection);
        } else {
            cmbDay.setSelectedItem(maxDays);
        }
    }

    private int getMaxDaysInMonth(int year, int month) {
        Calendar cal = Calendar.getInstance();
        cal.set(year, month - 1, 1);
        return cal.getActualMaximum(Calendar.DAY_OF_MONTH);
    }

    private void bookAppointment() {
        String doctorName = (String) cmbDoctorName.getSelectedItem();
        String time = txtTime.getText();

        if (doctorName == null || doctorName.isEmpty() || time.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please fill all fields", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        // Format the date
        int year = (Integer) cmbYear.getSelectedItem();
        int month = cmbMonth.getSelectedIndex() + 1;
        int day = (Integer) cmbDay.getSelectedItem();
        String date = String.format("%04d-%02d-%02d", year, month, day);

        // Extract doctor name and specialty
        String displayName = doctorName;
        String cleanDoctorName = doctorName;
        
        // Remove "Dr. " prefix and specialty for database
        if (doctorName.contains("(")) {
            cleanDoctorName = doctorName.substring(0, doctorName.indexOf("(")).trim();
        }
        cleanDoctorName = cleanDoctorName.replace("Dr. ", "").trim();

        // Create doctor and patient objects
        Doctor d = new Doctor("D" + (HospitalSystemClass.doctors.size() + 1), cleanDoctorName, "General");
        Patient p = new Patient("P" + (HospitalSystemClass.patients.size() + 1), patientName, 25);

        HospitalSystemClass.addDoctor(d);
        HospitalSystemClass.addPatient(p);
        HospitalSystemClass.addAppointment(new Appointment(d, p, date + " " + time));

        JOptionPane.showMessageDialog(this, 
            "Appointment booked successfully!\nWith " + displayName + "\nDate: " + date + " at " + time,
            "Success", JOptionPane.INFORMATION_MESSAGE);

        // Clear fields
        cmbDoctorName.setSelectedIndex(0);
        Calendar cal = Calendar.getInstance();
        cmbYear.setSelectedItem(cal.get(Calendar.YEAR));
        cmbMonth.setSelectedIndex(cal.get(Calendar.MONTH));
        cmbDay.setSelectedItem(cal.get(Calendar.DAY_OF_MONTH));
        txtTime.setText("");

        // Update list
        updateAppointmentList();
    }

    private void updateAppointmentList() {
        StringBuilder sb = new StringBuilder();
        sb.append("Your Appointments:\n");
        sb.append("=".repeat(60)).append("\n");
        
        int count = 0;
        for (int i = 0; i < HospitalSystemClass.appointments.size(); i++) {
            Appointment apt = HospitalSystemClass.appointments.get(i);
            
            if (apt.getPatient().getName().equalsIgnoreCase(patientName)) {
                count++;
                sb.append(count).append(". ");
                sb.append("Doctor: Dr. ").append(apt.getDoctor().getName());
                sb.append(" | DateTime: ").append(apt.getDate());
                sb.append("\n");
            }
        }
        
        if (count == 0) {
            sb.append("\nNo appointments yet. Book one above!\n");
        }
        
        txtAppointmentList.setText(sb.toString());
    }

    private void exportAppointments() {
        if (HospitalSystemClass.appointments.isEmpty()) {
            JOptionPane.showMessageDialog(this, "No appointments to export!", "Warning", JOptionPane.WARNING_MESSAGE);
            return;
        }

        try {
            JFileChooser fileChooser = new JFileChooser();
            fileChooser.setDialogTitle("Save Your Appointments");
            fileChooser.setSelectedFile(new java.io.File("MyAppointments.txt"));
            
            int userSelection = fileChooser.showSaveDialog(this);
            
            if (userSelection == JFileChooser.APPROVE_OPTION) {
                String filePath = fileChooser.getSelectedFile().getAbsolutePath();
                if (!filePath.endsWith(".txt")) {
                    filePath += ".txt";
                }

                PrintWriter writer = new PrintWriter(new FileWriter(filePath));
                writer.println("========================================");
                writer.println("   MY APPOINTMENTS - " + patientName);
                writer.println("========================================");
                writer.println();

                int count = 0;
                for (int i = 0; i < HospitalSystemClass.appointments.size(); i++) {
                    Appointment apt = HospitalSystemClass.appointments.get(i);
                    if (apt.getPatient().getName().equalsIgnoreCase(patientName)) {
                        count++;
                        writer.println(count + ". Doctor: Dr. " + apt.getDoctor().getName());
                        writer.println("   Date & Time: " + apt.getDate());
                        writer.println();
                    }
                }

                writer.println("========================================");
                writer.println("Total Appointments: " + count);
                writer.close();

                JOptionPane.showMessageDialog(this, "File exported successfully!", 
                                            "Success", JOptionPane.INFORMATION_MESSAGE);
            }
        } catch (Exception ex) {
            JOptionPane.showMessageDialog(this, "Error exporting file: " + ex.getMessage(), 
                                        "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void logout() {
        dispose();
        Login.main(null);
    }
    

    public static void main(String[] args) {
        new PatientForm("TestPatient").setVisible(true);
    }
}
