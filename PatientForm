package HospitalManagementSystem;

import javax.swing.*;
import java.awt.*;
import java.io.FileWriter;
import java.io.PrintWriter;
import java.util.Calendar;

public class PatientForm extends JFrame {

    private static final long serialVersionUID = 1L;
    private JComboBox<String> cmbDoctorName;
    private JComboBox<Integer> cmbYear, cmbDay;
    private JComboBox<String> cmbMonth;
    private JComboBox<String> cmbIllness; 
    private JTextField txtTime;
    private JTextField txtPatientName;  // NEW: Patient name field
    private JTextArea txtAppointmentList;
    private String patientName;

    public PatientForm(String username) {
    	 setIconImage(Toolkit.getDefaultToolkit().getImage("C:\\Users\\Owner\\eclipse-workspace\\HospitalManagementSystem\\image\\Hospital.png."));
        this.patientName = username;
        
        setTitle("Patient Portal - " + username);
        setExtendedState(JFrame.MAXIMIZED_BOTH); // Maximize the window
        setSize(520, 580);
        setLocationRelativeTo(null); // Center the window
        getContentPane().setLayout(null);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        
      
        getContentPane().setBackground(new Color(240, 248, 255));
        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();
        int screenWidth = screenSize.width;
        int screenHeight = screenSize.height;
        
        // Calculate margins and component sizes
        int leftMargin = 50;
        int topMargin = 30;
        int labelWidth = 150;
        int fieldWidth = Math.min(400, screenWidth - leftMargin - labelWidth - 100);
        int verticalSpacing = 50;
        
        // Medical theme colors
        Color headerColor = new Color(0, 102, 204); // Medical Blue
        Color panelColor = new Color(255, 255, 255); // White
        Color accentColor = new Color(46, 204, 113); // Medical Green
        Color dangerColor = new Color(231, 76, 60); // Red
        Color textColor = new Color(44, 62, 80); // Dark Blue Gray
        
        // Header Panel
        JPanel headerPanel = new JPanel();
        headerPanel.setBackground(headerColor);
        headerPanel.setBounds(0, 0, screenWidth, 80);
        headerPanel.setLayout(null);
        getContentPane().add(headerPanel);
        
        // Welcome message in header
        JLabel lblWelcome = new JLabel("Welcome, Dr. " + username + "!");
        lblWelcome.setFont(new Font("Tahoma", Font.BOLD, 24));
        lblWelcome.setForeground(Color.WHITE);
        lblWelcome.setBounds(leftMargin, 20, 600, 40);
        headerPanel.add(lblWelcome);
        
        // Booking Panel
        JPanel bookingPanel = new JPanel();
        bookingPanel.setBackground(panelColor);
        bookingPanel.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(189, 195, 199), 2),
            BorderFactory.createEmptyBorder(20, 20, 20, 20)
        ));
        bookingPanel.setLayout(null);
        bookingPanel.setBounds(50, 95, 1180, 320);  // CHANGED: Increased height from 278 to 320
        getContentPane().add(bookingPanel);

        // Book Appointment Section
        JLabel lblBooking = new JLabel("Book New Appointment");
        lblBooking.setFont(new Font("Tahoma", Font.BOLD, 18));
        lblBooking.setForeground(headerColor);
        lblBooking.setBounds(20, 0, 400, 35);
        bookingPanel.add(lblBooking);

        // NEW: Patient Name input
        JLabel lblPatientName = new JLabel("Patient Name:");
        lblPatientName.setFont(new Font("Tahoma", Font.PLAIN, 14));
        lblPatientName.setForeground(textColor);
        lblPatientName.setBounds(20, 46, labelWidth, 30);
        bookingPanel.add(lblPatientName);

        txtPatientName = new JTextField();
        txtPatientName.setFont(new Font("Tahoma", Font.PLAIN, 14));
        txtPatientName.setBounds(170, 46, 400, 35);
        txtPatientName.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(189, 195, 199), 1),
            BorderFactory.createEmptyBorder(5, 10, 5, 10)
        ));
        bookingPanel.add(txtPatientName);

        // Doctor input - CHANGED: Y position from 46 to 87
        JLabel lblDoctor = new JLabel("Doctor Name:");
        lblDoctor.setFont(new Font("Tahoma", Font.PLAIN, 14));
        lblDoctor.setForeground(textColor);
        lblDoctor.setBounds(20, 87, labelWidth, 30);
        bookingPanel.add(lblDoctor);

        // Dropdown for doctor selection - CHANGED: Y position from 46 to 87
        String[] doctors = {"Dr. Ash (Pediatricians)", "Dr. Triciajane (Cardiologist)", "Dr. Jean (Ophthalmologist)"};
        cmbDoctorName = new JComboBox<>(doctors);
        cmbDoctorName.setEditable(true);
        cmbDoctorName.setFont(new Font("Tahoma", Font.PLAIN, 14));
        cmbDoctorName.setBackground(Color.WHITE);
        cmbDoctorName.setBounds(170, 87, 400, 35);
        bookingPanel.add(cmbDoctorName);

        // NEW: Button to check doctor availability
        JButton btnCheckAvailability = new JButton("Check Availability");
        btnCheckAvailability.setFont(new Font("Tahoma", Font.BOLD, 12));
        btnCheckAvailability.setBackground(new Color(52, 152, 219));
        btnCheckAvailability.setForeground(Color.WHITE);
        btnCheckAvailability.setFocusPainted(false);
        btnCheckAvailability.setBounds(580, 87, 160, 35);
        btnCheckAvailability.setCursor(new Cursor(Cursor.HAND_CURSOR));
        bookingPanel.add(btnCheckAvailability);
        btnCheckAvailability.addActionListener(e -> checkDoctorAvailability());

        // Patient Illness - CHANGED: Y position from 87 to 128
        JLabel lblPatientIllness = new JLabel("Patient Illness:");
        lblPatientIllness.setForeground(new Color(44, 62, 80));
        lblPatientIllness.setFont(new Font("Tahoma", Font.PLAIN, 14));
        lblPatientIllness.setBounds(20, 128, 150, 30);
        bookingPanel.add(lblPatientIllness);

        String[] illnesses = {
                "Fever / Flu",
                "Heart Related",
                "Eye Problem"
        };
        
        cmbIllness = new JComboBox<>(illnesses);
        cmbIllness.setFont(new Font("Tahoma", Font.PLAIN, 14));
        cmbIllness.setBounds(170, 128, 300, 35);
        bookingPanel.add(cmbIllness);

        // Date input with dropdown selectors - CHANGED: Y position from 135 to 176
        JLabel lblDate = new JLabel("Appointment Date:");
        lblDate.setFont(new Font("Tahoma", Font.PLAIN, 14));
        lblDate.setForeground(textColor);
        lblDate.setBounds(20, 176, labelWidth, 30);
        bookingPanel.add(lblDate);

        // Year dropdown - CHANGED: Y position from 133 to 174
        Calendar cal = Calendar.getInstance();
        int currentYear = cal.get(Calendar.YEAR);
        Integer[] years = new Integer[10];
        for (int i = 0; i < 10; i++) {
            years[i] = currentYear + i;
        }
        cmbYear = new JComboBox<>(years);
        cmbYear.setFont(new Font("Tahoma", Font.PLAIN, 14));
        cmbYear.setBackground(Color.WHITE);
        cmbYear.setBounds(170, 174, 120, 35);
        bookingPanel.add(cmbYear);

        // Month dropdown - CHANGED: Y position from 133 to 174
        String[] months = {"Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                          "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
        cmbMonth = new JComboBox<>(months);
        cmbMonth.setFont(new Font("Tahoma", Font.PLAIN, 14));
        cmbMonth.setBackground(Color.WHITE);
        cmbMonth.setBounds(300, 174, 100, 35);
        cmbMonth.setSelectedIndex(cal.get(Calendar.MONTH));
        bookingPanel.add(cmbMonth);

        // Day dropdown - CHANGED: Y position from 133 to 174
        Integer[] days = new Integer[31];
        for (int i = 0; i < 31; i++) {
            days[i] = i + 1;
        }
        cmbDay = new JComboBox<>(days);
        cmbDay.setFont(new Font("Tahoma", Font.PLAIN, 14));
        cmbDay.setBackground(Color.WHITE);
        cmbDay.setBounds(410, 174, 80, 35);
        cmbDay.setSelectedIndex(cal.get(Calendar.DAY_OF_MONTH) - 1);
        bookingPanel.add(cmbDay);

        // Update days when month or year changes
        cmbMonth.addActionListener(e -> updateDays());
        cmbYear.addActionListener(e -> updateDays());

        // Time input - CHANGED: Y position from 183 to 224
        JLabel lblTime = new JLabel("Appointment Time:");
        lblTime.setFont(new Font("Tahoma", Font.PLAIN, 14));
        lblTime.setForeground(textColor);
        lblTime.setBounds(20, 224, labelWidth, 30);
        bookingPanel.add(lblTime);

        txtTime = new JTextField();
        txtTime.setFont(new Font("Tahoma", Font.PLAIN, 14));
        txtTime.setBounds(170, 222, 300, 35);
        txtTime.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(189, 195, 199), 1),
            BorderFactory.createEmptyBorder(5, 10, 5, 10)
        ));
        txtTime.setToolTipText("Format: HH:MM (e.g., 14:30)");
        bookingPanel.add(txtTime);

        // Book Appointment Button - CHANGED: Y position from 227 to 268
        JButton btnBookAppointment = new JButton("Book Appointment");
        btnBookAppointment.setFont(new Font("Tahoma", Font.BOLD, 14));
        btnBookAppointment.setBackground(accentColor);
        btnBookAppointment.setForeground(Color.WHITE);
        btnBookAppointment.setFocusPainted(false);
        btnBookAppointment.setBorder(BorderFactory.createEmptyBorder(10, 20, 10, 20));
        btnBookAppointment.setBounds(170, 268, 180, 40);
        btnBookAppointment.setCursor(new Cursor(Cursor.HAND_CURSOR));
        bookingPanel.add(btnBookAppointment);

        btnBookAppointment.addActionListener(e -> bookAppointment());

        // Logout button
        JButton btnLogout = new JButton("Logout");
        btnLogout.setFont(new Font("Tahoma", Font.BOLD, 14));
        btnLogout.setBackground(dangerColor);
        btnLogout.setForeground(Color.WHITE);
        btnLogout.setFocusPainted(false);
        btnLogout.setBorder(BorderFactory.createEmptyBorder(10, 20, 10, 20));
        btnLogout.setBounds(1000, 25, 120, 35);
        btnLogout.setCursor(new Cursor(Cursor.HAND_CURSOR));
        bookingPanel.add(btnLogout);
        
        btnLogout.addActionListener(e -> logout());
        
        // Appointments Panel - CHANGED: Y position from 380 to 422 (to accommodate larger booking panel)
        JPanel appointmentsPanel = new JPanel();
        appointmentsPanel.setBackground(panelColor);
        appointmentsPanel.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(189, 195, 199), 2),
            BorderFactory.createEmptyBorder(20, 20, 20, 20)
        ));
        appointmentsPanel.setLayout(null);
        int appointmentsPanelHeight = screenHeight - 492;  // CHANGED: from 450 to 492
        appointmentsPanel.setBounds(leftMargin, 422, screenWidth - 2 * leftMargin, appointmentsPanelHeight);
        getContentPane().add(appointmentsPanel);

        // My Appointments Section
        JLabel lblMyAppointments = new JLabel("My Appointments");
        lblMyAppointments.setFont(new Font("Tahoma", Font.BOLD, 18));
        lblMyAppointments.setForeground(headerColor);
        lblMyAppointments.setBounds(20, 10, 300, 35);
        appointmentsPanel.add(lblMyAppointments);

        txtAppointmentList = new JTextArea();
        txtAppointmentList.setEditable(false);
        txtAppointmentList.setFont(new Font("Monospaced", Font.PLAIN, 14));
        txtAppointmentList.setBackground(new Color(248, 249, 250));
        txtAppointmentList.setForeground(textColor);
        txtAppointmentList.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));
        
        JScrollPane scrollPane = new JScrollPane(txtAppointmentList);
        scrollPane.setBorder(BorderFactory.createLineBorder(new Color(189, 195, 199), 1));
        int scrollWidth = screenWidth - 2 * leftMargin - 80;
        int scrollHeight = appointmentsPanelHeight - 80;
        scrollPane.setBounds(20, 55, scrollWidth, scrollHeight);
        appointmentsPanel.add(scrollPane);
        
        // Load appointments
        updateAppointmentList();
    }

    private void updateDays() {
        int year = (Integer) cmbYear.getSelectedItem();
        int month = cmbMonth.getSelectedIndex() + 1;
        int maxDays = getMaxDaysInMonth(year, month);
        
        int currentSelection = (Integer) cmbDay.getSelectedItem();
        
        cmbDay.removeAllItems();
        for (int i = 1; i <= maxDays; i++) {
            cmbDay.addItem(i);
        }
        
        if (currentSelection <= maxDays) {
            cmbDay.setSelectedItem(currentSelection);
        } else {
            cmbDay.setSelectedItem(maxDays);
        }
    }

    private int getMaxDaysInMonth(int year, int month) {
        Calendar cal = Calendar.getInstance();
        cal.set(year, month - 1, 1);
        return cal.getActualMaximum(Calendar.DAY_OF_MONTH);
    }

    private void bookAppointment() {
        // CHANGED: Get patient name from text field instead of username
        String bookingPatientName = txtPatientName.getText().trim();
        String doctorName = (String) cmbDoctorName.getSelectedItem();
        String time = txtTime.getText();

        // CHANGED: Added validation for patient name
        if (bookingPatientName.isEmpty() || doctorName == null || doctorName.isEmpty() || time.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please fill all fields", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        // Format the date
        int year = (Integer) cmbYear.getSelectedItem();
        int month = cmbMonth.getSelectedIndex() + 1;
        int day = (Integer) cmbDay.getSelectedItem();
        String date = String.format("%04d-%02d-%02d", year, month, day);

        // Extract doctor name and specialty
        String displayName = doctorName;
        String cleanDoctorName = doctorName;
        
        // Remove "Dr. " prefix and specialty for database
        if (doctorName.contains("(")) {
            cleanDoctorName = doctorName.substring(0, doctorName.indexOf("(")).trim();
        }
        cleanDoctorName = cleanDoctorName.replace("Dr. ", "").trim();

        // CHANGED: Use the patient name from text field
        Doctor d = new Doctor("D" + (Hospital.doctors.size() + 1), cleanDoctorName, "General");
        Patient p = new Patient("P" + (Hospital.patients.size() + 1), bookingPatientName, 25);

        Hospital.addDoctor(d);
        Hospital.addPatient(p);
        Hospital.addAppointment(new Appointment(d, p, date + " " + time));

        JOptionPane.showMessageDialog(this, 
            "Appointment booked successfully!\nPatient: " + bookingPatientName + "\nWith " + displayName + "\nDate: " + date + " at " + time,
            "Success", JOptionPane.INFORMATION_MESSAGE);

        // CHANGED: Clear patient name field too
        txtPatientName.setText("");
        cmbDoctorName.setSelectedIndex(0);
        Calendar cal = Calendar.getInstance();
        cmbYear.setSelectedItem(cal.get(Calendar.YEAR));
        cmbMonth.setSelectedIndex(cal.get(Calendar.MONTH));
        cmbDay.setSelectedItem(cal.get(Calendar.DAY_OF_MONTH));
        txtTime.setText("");

        // Update list
        updateAppointmentList();
    }

    private void updateAppointmentList() {
        StringBuilder sb = new StringBuilder();
        sb.append("All Appointments:\n");

        // Replace String.repeat with a loop for Java 8 compatibility
        for (int i = 0; i < 60; i++) {
            sb.append("=");
        }
        sb.append("\n");

        int count = 0;
        for (int i = 0; i < Hospital.appointments.size(); i++) {
            Appointment apt = Hospital.appointments.get(i);
            
            // Show all appointments instead of filtering by username
            count++;
            sb.append(count).append(". ");
            sb.append("Patient: ").append(apt.getPatient().getName());
            sb.append(" | Doctor: Dr. ").append(apt.getDoctor().getName());
            sb.append(" | DateTime: ").append(apt.getDate());
            sb.append("\n");
        }
        
        if (count == 0) {
            sb.append("No appointments scheduled yet.\n");
        }
        
        txtAppointmentList.setText(sb.toString());
    }

    private void checkDoctorAvailability() {
        String selectedDoctor = (String) cmbDoctorName.getSelectedItem();
        
        if (selectedDoctor == null || selectedDoctor.isEmpty()) {
            JOptionPane.showMessageDialog(this, 
                "Please select a doctor first", 
                "No Doctor Selected", 
                JOptionPane.WARNING_MESSAGE);
            return;
        }

        // Extract clean doctor name - remove "Dr. " prefix and specialty
        String cleanDoctorName = selectedDoctor;
        if (selectedDoctor.contains("(")) {
            cleanDoctorName = selectedDoctor.substring(0, selectedDoctor.indexOf("(")).trim();
        }
        cleanDoctorName = cleanDoctorName.replace("Dr. ", "").trim();
        
        // Map the display names to the actual doctor usernames used in DoctorForm
        // This ensures the HashMap lookup works correctly
        String doctorUsername = cleanDoctorName;
        if (cleanDoctorName.equalsIgnoreCase("Ash")) {
            doctorUsername = "Ash";
        } else if (cleanDoctorName.equalsIgnoreCase("Tricia")) {
            doctorUsername = "Tricia";
        } else if (cleanDoctorName.equalsIgnoreCase("Jean")) {
            doctorUsername = "Jean";
        }

        // Get selected date
        int year = (Integer) cmbYear.getSelectedItem();
        int month = cmbMonth.getSelectedIndex() + 1;
        int day = (Integer) cmbDay.getSelectedItem();
        String selectedDate = String.format("%04d-%02d-%02d", year, month, day);

        // Get doctor's current availability status using the username
        String doctorStatus = Hospital.getDoctorAvailability(doctorUsername);
        if (doctorStatus == null) {
            doctorStatus = "Available"; // Default status
        }

        // Check appointments for this doctor on this date
        StringBuilder appointmentInfo = new StringBuilder();
        appointmentInfo.append("Doctor: ").append(selectedDoctor).append("\n");
        appointmentInfo.append("Current Status: ").append(doctorStatus).append("\n");
        appointmentInfo.append("Date: ").append(selectedDate).append("\n\n");
        
        // Show status with appropriate indicator
        if (doctorStatus.equalsIgnoreCase("Available")) {
            appointmentInfo.append("✓ Doctor is AVAILABLE\n\n");
        } else if (doctorStatus.equalsIgnoreCase("Busy")) {
            appointmentInfo.append("⚠ Doctor is currently BUSY\n\n");
        } else if (doctorStatus.equalsIgnoreCase("Off Duty")) {
            appointmentInfo.append("✗ Doctor is OFF DUTY\n\n");
        } else if (doctorStatus.equalsIgnoreCase("On Call")) {
            appointmentInfo.append("⚕ Doctor is ON CALL\n\n");
        }
        
        // Show scheduled appointments for this date
        appointmentInfo.append("Scheduled Appointments on ").append(selectedDate).append(":\n");
        int appointmentCount = 0;
        for (Appointment apt : Hospital.appointments) {
            if (apt.getDoctor().getName().equalsIgnoreCase(cleanDoctorName) && 
                apt.getDate().startsWith(selectedDate)) {
                appointmentCount++;
                appointmentInfo.append("• ").append(apt.getDate()).append(" - ")
                              .append(apt.getPatient().getName()).append("\n");
            }
        }

        if (appointmentCount == 0) {
            appointmentInfo.append("No appointments scheduled yet.\n");
        }

        // Add recommendation based on status
        appointmentInfo.append("\n");
        if (doctorStatus.equalsIgnoreCase("Off Duty")) {
            appointmentInfo.append("⚠ Warning: Doctor is off duty. Please choose another day or doctor.");
        } else if (doctorStatus.equalsIgnoreCase("Busy")) {
            appointmentInfo.append("Note: Doctor is busy but you may still book for available time slots.");
        }

        JOptionPane.showMessageDialog(this, 
            appointmentInfo.toString(),
            "Doctor Availability", 
            JOptionPane.INFORMATION_MESSAGE);
    }
     
    private void logout() {
        dispose();
        Login.main(null);
    }
    

    public static void main(String[] args) {
        new PatientForm("TestPatient").setVisible(true);
    }
}
